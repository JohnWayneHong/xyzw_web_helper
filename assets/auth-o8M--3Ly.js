const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/wsAgent-CKJuR7PJ.js","assets/index-RWkRG8TU.js","assets/index-Om8NWQ_d.css","assets/gameCommands-CoL8iq45.js"])))=>i.map(i=>d[i]);
import{D as J,r as k,A as d,_ as x}from"./index-RWkRG8TU.js";const N=J("localToken",()=>{const u=k(localStorage.getItem("userToken")||null),s=k(JSON.parse(localStorage.getItem("gameTokens")||"{}")),n=k({}),S=d(()=>!!u.value),w=d(()=>Object.keys(s.value).length>0),y=e=>{u.value=e,localStorage.setItem("userToken",e)},h=()=>{u.value=null,localStorage.removeItem("userToken")},p=(e,t)=>{const g={...t,roleId:e,createdAt:new Date().toISOString(),lastUsed:new Date().toISOString()};return s.value[e]=g,localStorage.setItem("gameTokens",JSON.stringify(s.value)),g},v=e=>{const t=s.value[e];return t&&(t.lastUsed=new Date().toISOString(),localStorage.setItem("gameTokens",JSON.stringify(s.value))),t},U=(e,t)=>{s.value[e]&&(s.value[e]={...s.value[e],...t,updatedAt:new Date().toISOString()},localStorage.setItem("gameTokens",JSON.stringify(s.value)))},_=e=>{delete s.value[e],localStorage.setItem("gameTokens",JSON.stringify(s.value)),n.value[e]&&f(e)},r=()=>{Object.keys(n.value).forEach(e=>{f(e)}),s.value={},localStorage.removeItem("gameTokens")},i=async(e,t,g=null)=>{n.value[e]&&f(e);try{const{WsAgent:a}=await x(async()=>{const{WsAgent:l}=await import("./wsAgent-CKJuR7PJ.js");return{WsAgent:l}},__vite__mapDeps([0,1,2])),{gameCommands:o}=await x(async()=>{const{gameCommands:l}=await import("./gameCommands-CoL8iq45.js");return{gameCommands:l}},__vite__mapDeps([3,1,2]));let c=t;try{const l=t.replace(/^data:.*base64,/,"").trim(),O=atob(l);try{const D=JSON.parse(O);c=D.token||D.gameToken||O}catch{c=O}}catch(l){console.warn("Base64解析失败，使用原始token:",l.message),c=t}const m=new a({heartbeatInterval:2e3,queueInterval:50,channel:"x",autoReconnect:!0,maxReconnectAttempts:5});m.onOpen=()=>{n.value[e].status="connected",n.value[e].connectedAt=new Date().toISOString(),setTimeout(()=>{m.send(o.role_getroleinfo(0,0,{roleId:e})),m.send(o.system_getdatabundlever())},1e3)},m.onMessage=l=>{l.cmd&&T(e,l)},m.onError=l=>{console.error(`❌ WebSocket错误 [${e}]:`,l),n.value[e]&&(n.value[e].status="error",n.value[e].lastError=l.message)},m.onClose=l=>{n.value[e]&&(n.value[e].status="disconnected")},m.onReconnect=l=>{n.value[e]&&(n.value[e].status="reconnecting",n.value[e].reconnectAttempt=l)};const E=g||a.buildUrl("wss://xxz-xyzw.hortorgames.com/agent",{p:c,e:"x",lang:"chinese"});return n.value[e]={agent:m,gameCommands:o,status:"connecting",roleId:e,wsUrl:E,actualToken:c,createdAt:new Date().toISOString(),lastError:null,reconnectAttempt:0},await m.connect(E),m}catch(a){return console.error(`创建WebSocket连接失败 [${e}]:`,a),n.value[e]&&(n.value[e].status="error",n.value[e].lastError=a.message),null}},T=(e,t)=>{const{cmd:g,body:a}=t},f=e=>{const t=n.value[e];t&&(t.agent&&typeof t.agent.close=="function"?t.agent.close():t.connection&&typeof t.connection.close=="function"&&t.connection.close(),delete n.value[e])},A=e=>{var t;return((t=n.value[e])==null?void 0:t.status)||"disconnected"},W=(e,t,g={})=>{const a=n.value[e];if(!a||!a.agent||a.status!=="connected")return!1;try{const{gameCommands:o}=a;if(typeof o[t]=="function"){const c=o[t](0,0,g);return a.agent.send(c),!0}else return console.error(`未知的游戏命令: ${t}`),!1}catch(o){return console.error(`发送游戏命令失败 [${e}] ${t}:`,o),!1}},C=async(e,t,g={},a=8e3)=>{const o=n.value[e];if(!o||!o.agent)throw new Error(`角色 ${e} 的WebSocket连接不存在`);if(o.status!=="connected")throw new Error(`角色 ${e} 的WebSocket未连接`);try{const{gameCommands:c}=o;if(typeof c[t]=="function")return await o.agent.sendWithPromise({cmd:t,body:g,timeout:a});throw new Error(`未知的游戏命令: ${t}`)}catch(c){throw console.error(`发送游戏命令失败 [${e}] ${t}:`,c),c}},G=e=>{const t=n.value[e];return t?{status:t.status,roleId:t.roleId,wsUrl:t.wsUrl,connectedAt:t.connectedAt,createdAt:t.createdAt,lastError:t.lastError,reconnectAttempt:t.reconnectAttempt,agentStatus:t.agent?t.agent.getStatus():null}:{status:"disconnected",roleId:e,error:"连接不存在"}},$=()=>({userToken:u.value,gameTokens:s.value,exportedAt:new Date().toISOString()}),I=e=>{try{return e.userToken&&y(e.userToken),e.gameTokens&&(s.value=e.gameTokens,localStorage.setItem("gameTokens",JSON.stringify(s.value))),{success:!0,message:"Token导入成功"}}catch(t){return console.error("Token导入失败:",t),{success:!1,message:"导入失败：数据格式错误"}}},b=()=>{const e=new Date,t=new Date(e.getTime()-24*60*60*1e3),g={};let a=0;return Object.entries(s.value).forEach(([o,c])=>{new Date(c.lastUsed||c.createdAt)>t?g[o]=c:(a++,n.value[o]&&f(o))}),s.value=g,localStorage.setItem("gameTokens",JSON.stringify(s.value)),a};return{userToken:u,gameTokens:s,wsConnections:n,isUserAuthenticated:S,hasGameTokens:w,setUserToken:y,clearUserToken:h,addGameToken:p,getGameToken:v,updateGameToken:U,removeGameToken:_,clearAllGameTokens:r,createWebSocketConnection:i,closeWebSocketConnection:f,getWebSocketStatus:A,getWebSocketDetails:G,sendGameCommand:W,sendGameCommandWithPromise:C,exportTokens:$,importTokens:I,cleanExpiredTokens:b,initTokenManager:()=>{const e=localStorage.getItem("userToken"),t=localStorage.getItem("gameTokens");if(e&&(u.value=e),t)try{s.value=JSON.parse(t)}catch(g){console.error("解析游戏token数据失败:",g),s.value={}}b()}}}),L=J("auth",()=>{const u=k(null),s=k(localStorage.getItem("token")||null),n=k(!1),S=N(),w=d(()=>!!s.value&&!!u.value),y=d(()=>u.value),h=async r=>{try{n.value=!0;const i={id:"local_user_"+Date.now(),username:r.username,email:r.email||`${r.username}@local.game`,avatar:"/icons/xiaoyugan.png",createdAt:new Date().toISOString()},T="local_token_"+Date.now()+"_"+Math.random().toString(36).substr(2,9);return s.value=T,u.value=i,localStorage.setItem("token",s.value),localStorage.setItem("user",JSON.stringify(u.value)),S.setUserToken(T),{success:!0}}catch(i){return console.error("登录错误:",i),{success:!1,message:"本地认证失败"}}finally{n.value=!1}},p=async r=>{try{n.value=!0;const i=JSON.parse(localStorage.getItem("registeredUsers")||"[]");if(i.some(A=>A.username===r.username))return{success:!1,message:"用户名已存在"};const f={...r,id:"user_"+Date.now(),createdAt:new Date().toISOString()};return i.push(f),localStorage.setItem("registeredUsers",JSON.stringify(i)),{success:!0,message:"注册成功，请登录"}}catch(i){return console.error("注册错误:",i),{success:!1,message:"本地注册失败"}}finally{n.value=!1}},v=()=>{u.value=null,s.value=null,localStorage.removeItem("token"),localStorage.removeItem("user"),localStorage.removeItem("gameRoles"),S.clearUserToken(),S.clearAllGameTokens()};return{user:u,token:s,isLoading:n,isAuthenticated:w,userInfo:y,login:h,register:p,logout:v,fetchUserInfo:async()=>{try{if(!s.value)return!1;const r=localStorage.getItem("user");if(r)try{return u.value=JSON.parse(r),!0}catch(i){return console.error("解析用户信息失败:",i),v(),!1}else return v(),!1}catch(r){return console.error("获取用户信息失败:",r),v(),!1}},initAuth:async()=>{const r=localStorage.getItem("user");if(s.value&&r)try{u.value=JSON.parse(r),S.initTokenManager()}catch(i){console.error("初始化认证失败:",i),v()}}}});export{N as a,L as u};
