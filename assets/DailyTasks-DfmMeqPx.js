import{d as ie,c as g,o as v,a as s,m as X,r as x,s as Y,v as h,g as n,t as f,x as N,w as i,i as p,u as C,l as _,F as G,j as K,f as H,n as ce,p as re,A as V,b as de,h as ue}from"./index-RWkRG8TU.js";import{_ as Z}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{S as Q}from"./Settings-GOSa6bMc.js";import{C as me,a as ve}from"./Time-BbfkzzPG.js";import{R as ge}from"./Refresh-7PsdRDpj.js";import{S as ke}from"./Search-DIpfDEOX.js";import{C as fe}from"./Cube-D3BTRuJz.js";const pe={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},_e=s("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32",d:"M416 128L192 384l-96-96"},null,-1),he=[_e],ye=ie({name:"Checkmark",render:function(W,u){return v(),g("svg",pe,he)}}),we={class:"card-header"},xe={class:"header-left"},Se=["src","alt"],be={class:"title-container"},$e={class:"title"},Te={key:0,class:"subtitle"},Ce={class:"header-right"},Re={key:0,class:"progress-container"},De={class:"info-container"},Ee={class:"info-item"},Oe={class:"info-value"},Ue={key:0,class:"info-item"},Ae={class:"info-value"},Ie={key:1,class:"info-item"},Le={class:"info-value"},Ne={key:1,class:"actions-container"},We={class:"modal-header"},ze={class:"settings-content"},Be={class:"settings-grid"},Pe={class:"setting-item"},Me={class:"setting-item"},Fe={class:"setting-item"},Ve={key:0,class:"task-details"},je={class:"task-list"},Je={class:"task-item-left"},qe={class:"task-name"},Ge={key:1,class:"execution-log"},Ke={class:"log-container"},He={class:"log-time"},Qe={__name:"DailyTaskCard",props:{task:{type:Object,required:!0}},emits:["update:task","execute","toggle-status"],setup(c,{emit:W}){var L,z,B;const u=c,R=W,y=X(),S=x(!1),w=x(!1),l=x({autoExecute:((L=u.task.settings)==null?void 0:L.autoExecute)||!1,delay:((z=u.task.settings)==null?void 0:z.delay)||0,notification:((B=u.task.settings)==null?void 0:B.notification)||!0}),O=()=>w.value?"执行中...":u.task.canExecute?"立即执行":"不可执行",D=()=>{R("toggle-status",u.task.id)},r=async()=>{if(!(w.value||!u.task.canExecute))try{w.value=!0,await R("execute",u.task.id),l.value.notification&&y.success(`任务 "${u.task.title}" 执行成功`)}catch(k){y.error(`任务执行失败: ${k.message}`)}finally{w.value=!1}},A=(k,a)=>{l.value[k]=a,R("update:task",{...u.task,settings:{...l.value}})},j=k=>new Date(k).toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}),I=k=>new Date(k).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit",second:"2-digit"});return Y(()=>u.task.settings,k=>{k&&(l.value={...l.value,...k})},{immediate:!0}),(k,a)=>{const U=p("n-icon"),P=p("n-button"),M=p("n-checkbox"),F=p("n-input-number"),J=p("n-modal");return v(),g("div",{class:N(["daily-task-card",{completed:c.task.completed}])},[s("div",we,[s("div",xe,[s("img",{src:c.task.icon||"/icons/ta.png",alt:c.task.title,class:"task-icon"},null,8,Se),s("div",be,[s("h3",$e,f(c.task.title),1),c.task.subtitle?(v(),g("p",Te,f(c.task.subtitle),1)):h("",!0)])]),s("div",Ce,[s("div",{class:N(["status-indicator",{completed:c.task.completed}]),onClick:D},[s("span",{class:N(["status-dot",{completed:c.task.completed}])},null,2),s("span",null,f(c.task.completed?"已完成":"待完成"),1)],2),n(P,{text:"",class:"settings-button",onClick:a[0]||(a[0]=d=>S.value=!0)},{icon:i(()=>[n(U,{class:"settings-icon"},{default:i(()=>[n(C(Q))]),_:1})]),_:1})])]),c.task.progress?(v(),g("div",Re,[s("div",De,[s("div",Ee,[a[8]||(a[8]=s("span",{class:"info-label"},"当前进度",-1)),s("span",Oe,f(c.task.progress.current)+"/"+f(c.task.progress.total),1)]),c.task.reward?(v(),g("div",Ue,[a[9]||(a[9]=s("span",{class:"info-label"},"奖励",-1)),s("span",Ae,f(c.task.reward),1)])):h("",!0),c.task.nextReset?(v(),g("div",Ie,[a[10]||(a[10]=s("span",{class:"info-label"},"重置时间",-1)),s("span",Le,f(j(c.task.nextReset)),1)])):h("",!0)])])):h("",!0),c.task.completed?h("",!0):(v(),g("div",Ne,[n(P,{type:"primary",block:"",loading:w.value,disabled:!c.task.canExecute,class:"complete-button",onClick:r},{default:i(()=>[_(f(O()),1)]),_:1},8,["loading","disabled"])])),n(J,{show:S.value,"onUpdate:show":a[7]||(a[7]=d=>S.value=d),preset:"card",title:"任务设置",style:{width:"480px"}},{header:i(()=>[s("div",We,[n(U,{class:"modal-icon"},{default:i(()=>[n(C(Q))]),_:1}),s("span",null,f(c.task.title)+" - 设置",1)])]),default:i(()=>[s("div",ze,[s("div",Be,[s("div",Pe,[n(M,{checked:l.value.autoExecute,"onUpdate:checked":[a[1]||(a[1]=d=>l.value.autoExecute=d),a[2]||(a[2]=d=>A("autoExecute",d))]},{default:i(()=>a[11]||(a[11]=[_(" 自动执行 ",-1)])),_:1,__:[11]},8,["checked"])]),s("div",Me,[a[12]||(a[12]=s("label",{class:"setting-label"},"执行延迟 (秒)",-1)),n(F,{value:l.value.delay,"onUpdate:value":[a[3]||(a[3]=d=>l.value.delay=d),a[4]||(a[4]=d=>A("delay",d))],min:0,max:300},null,8,["value"])]),s("div",Fe,[n(M,{checked:l.value.notification,"onUpdate:checked":[a[5]||(a[5]=d=>l.value.notification=d),a[6]||(a[6]=d=>A("notification",d))]},{default:i(()=>a[13]||(a[13]=[_(" 完成通知 ",-1)])),_:1,__:[13]},8,["checked"])])]),c.task.details?(v(),g("div",Ve,[a[14]||(a[14]=s("h4",null,"任务详情",-1)),s("div",je,[(v(!0),g(G,null,K(c.task.details,d=>(v(),g("div",{key:d.id,class:"task-item"},[s("div",Je,[n(U,{class:N(["task-status-icon",{completed:d.completed}])},{default:i(()=>[d.completed?(v(),H(C(ye),{key:0})):(v(),H(C(me),{key:1}))]),_:2},1032,["class"]),s("span",qe,f(d.name),1)])]))),128))])])):h("",!0),c.task.logs&&c.task.logs.length?(v(),g("div",Ge,[a[15]||(a[15]=s("h4",null,"执行日志",-1)),s("div",Ke,[(v(!0),g(G,null,K(c.task.logs.slice(-5),d=>(v(),g("div",{key:d.id,class:"log-item"},[s("span",He,f(I(d.timestamp)),1),s("span",{class:N(["log-message",{error:d.type==="error",success:d.type==="success"}])},f(d.message),3)]))),128))])])):h("",!0)])]),_:1},8,["show"])],2)}}},Xe=Z(Qe,[["__scopeId","data-v-0e45c58a"]]),Ye={class:"daily-tasks-page"},Ze={class:"page-header"},et={class:"container"},tt={class:"header-content"},st={class:"header-actions"},at={class:"role-selector-section"},ot={class:"container"},nt={class:"role-selector"},lt={key:0,class:"role-stats"},it={class:"stat-item"},ct={class:"stat-value"},rt={class:"stat-item"},dt={class:"stat-value"},ut={class:"stat-item"},mt={class:"stat-value"},vt={class:"filter-section"},gt={class:"container"},kt={class:"filter-bar"},ft={class:"search-box"},pt={class:"tasks-section"},_t={class:"container"},ht={key:0,class:"tasks-grid"},yt={key:1,class:"empty-state"},wt={key:2,class:"loading-state"},xt={__name:"DailyTasks",setup(c){const W=ue(),u=X(),R=ce(),y=re(),S=x(!1),w=x(!1),l=x(null),O=x("all"),D=x(""),r=x([]),A=V(()=>gameRolesStore.gameRoles.find(t=>t.id===l.value)),j=V(()=>gameRolesStore.gameRoles.map(t=>({label:`${t.name} (${t.server})`,value:t.id}))),I=V(()=>{const t=r.value.length,e=r.value.filter(m=>m.completed).length,o=t>0?Math.round(e/t*100):0;return{total:t,completed:e,percentage:o}}),L=V(()=>{let t=r.value;switch(O.value){case"pending":t=t.filter(e=>!e.completed);break;case"completed":t=t.filter(e=>e.completed);break;case"auto":t=t.filter(e=>{var o;return(o=e.settings)==null?void 0:o.autoExecute});break}if(D.value){const e=D.value.toLowerCase();t=t.filter(o=>{var m;return o.title.toLowerCase().includes(e)||((m=o.subtitle)==null?void 0:m.toLowerCase().includes(e))})}return t}),z=[{label:"执行所有待完成任务",key:"execute-all-pending"},{label:"标记所有为已完成",key:"mark-all-completed"},{label:"重置所有任务状态",key:"reset-all-tasks"}],B=async(t,e=3,o=2e3)=>{for(let m=1;m<=e;m++)try{if(y.getWebSocketStatus(t)!=="connected"){const $=y.gameTokens.find(E=>E.id===t);if($&&$.token){if(y.createWebSocketConnection(t,$.token,$.wsUrl),await new Promise(q=>setTimeout(q,o)),y.getWebSocketStatus(t)!=="connected"){if(m<e)continue;throw new Error("WebSocket连接超时")}}else throw new Error("未找到有效的Token数据或WebSocket URL")}u.success("阵容数据已更新")}catch(b){if(console.error(`第${m}次尝试失败:`,b),m<e)await new Promise($=>setTimeout($,o));else return console.error("所有重试均失败，阵容数据加载失败"),u.warning(`阵容数据加载失败: ${b.message||"未知错误"}`),null}},k=async()=>{if(!l.value){u.warning("请先选择游戏角色");return}try{w.value=!0,S.value=!0;const t=a(l.value);r.value=t,localStorage.setItem(`dailyTasks_${l.value}`,JSON.stringify(t)),u.success("任务数据刷新成功")}catch(t){console.error("刷新任务失败:",t),u.error("本地数据生成失败")}finally{w.value=!1,S.value=!1}},a=t=>{const e=gameRolesStore.gameRoles.find(o=>o.id===t);return e!=null&&e.name,[{id:`task_${t}_daily_signin`,title:"每日签到",subtitle:"登录游戏获取签到奖励",icon:"/icons/ta.png",completed:!1,canExecute:!0,progress:{current:0,total:1},reward:"金币 x100, 经验 x50",nextReset:new Date(Date.now()+24*60*60*1e3).toISOString(),settings:{autoExecute:!1,delay:0,notification:!0},details:[{id:1,name:"打开游戏客户端",completed:!1},{id:2,name:"点击签到按钮",completed:!1}],logs:[]},{id:`task_${t}_daily_quest`,title:"完成日常任务",subtitle:"完成5个日常任务获得奖励",icon:"/icons/ta.png",completed:!1,canExecute:!0,progress:{current:2,total:5},reward:"金币 x500, 装备碎片 x10",nextReset:new Date(Date.now()+24*60*60*1e3).toISOString(),settings:{autoExecute:!0,delay:5,notification:!0},details:[{id:1,name:"击败10只怪物",completed:!0},{id:2,name:"收集20个材料",completed:!0},{id:3,name:"完成一次副本",completed:!1},{id:4,name:"参与公会活动",completed:!1},{id:5,name:"强化装备",completed:!1}],logs:[{id:1,timestamp:Date.now()-30*60*1e3,type:"success",message:"已完成击败怪物任务"},{id:2,timestamp:Date.now()-60*60*1e3,type:"success",message:"已完成材料收集任务"}]},{id:`task_${t}_guild_contribution`,title:"公会贡献",subtitle:"为公会贡献资源获得贡献点",icon:"/icons/ta.png",completed:!0,canExecute:!1,progress:{current:1,total:1},reward:"公会贡献点 x100",nextReset:new Date(Date.now()+24*60*60*1e3).toISOString(),settings:{autoExecute:!0,delay:0,notification:!0},details:[{id:1,name:"捐献金币",completed:!0}],logs:[{id:1,timestamp:Date.now()-2*60*60*1e3,type:"success",message:"已完成公会贡献"}]}]},U=t=>{l.value=t,gameRolesStore.selectRole(gameRolesStore.gameRoles.find(e=>e.id===t)),t&&k()},P=t=>{O.value=t},M=t=>{D.value=t},F=async t=>{if(!l.value){u.error("请先选择游戏角色");return}try{if(localTokenStore.getWebSocketStatus(l.value)!=="connected"){const m=localTokenStore.getGameToken(l.value);if(m)localTokenStore.createWebSocketConnection(l.value,m.token,m.wsUrl),await new Promise(b=>setTimeout(b,1e3));else throw new Error("未找到游戏token，请重新添加角色")}const o=r.value.findIndex(m=>m.id===t);o!==-1&&(r.value[o]={...r.value[o],completed:!0,completedAt:new Date().toISOString()},r.value[o].logs||(r.value[o].logs=[]),r.value[o].logs.push({id:Date.now(),timestamp:Date.now(),type:"success",message:`任务 "${r.value[o].title}" 执行成功`}),localStorage.setItem(`dailyTasks_${l.value}`,JSON.stringify(r.value))),u.success("任务执行成功")}catch(e){console.error("执行任务失败:",e);const o=r.value.findIndex(m=>m.id===t);throw o!==-1&&(r.value[o].logs||(r.value[o].logs=[]),r.value[o].logs.push({id:Date.now(),timestamp:Date.now(),type:"error",message:`任务执行失败: ${e.message}`})),e}},J=t=>{const e=r.value.findIndex(o=>o.id===t);e!==-1&&(r.value[e].completed=!r.value[e].completed,u.info("任务状态已更新"))},d=t=>{const e=r.value.findIndex(o=>o.id===t.id);e!==-1&&(r.value[e]=t)},ee=t=>{switch(t){case"execute-all-pending":te();break;case"mark-all-completed":se();break;case"reset-all-tasks":ae();break}},te=async()=>{const t=r.value.filter(e=>!e.completed&&e.canExecute);if(t.length===0){u.info("没有可执行的待完成任务");return}R.confirm({title:"批量执行任务",content:`确定要执行 ${t.length} 个待完成任务吗？`,positiveText:"确定",negativeText:"取消",onPositiveClick:async()=>{let e=0,o=0;for(const m of t)try{await F(m.id),e++}catch{o++}u.info(`批量执行完成：成功 ${e} 个，失败 ${o} 个`)}})},se=()=>{const t=r.value.filter(e=>!e.completed);if(t.length===0){u.info("所有任务都已完成");return}R.confirm({title:"标记所有任务为已完成",content:`确定要将 ${t.length} 个待完成任务标记为已完成吗？`,positiveText:"确定",negativeText:"取消",onPositiveClick:()=>{t.forEach(e=>{e.completed=!0,e.completedAt=new Date().toISOString()}),u.success("所有任务已标记为完成")}})},ae=()=>{R.confirm({title:"重置所有任务状态",content:"确定要重置所有任务状态吗？此操作将清除所有完成记录。",positiveText:"确定",negativeText:"取消",onPositiveClick:()=>{r.value.forEach(t=>{t.completed=!1,t.completedAt=null}),u.success("所有任务状态已重置")}})};return de(async()=>{if(!authStore.isAuthenticated){W.push("/login");return}if(gameRolesStore.gameRoles.length===0&&await gameRolesStore.fetchGameRoles(),y.selectedToken&&await B(y.selectedToken.id),gameRolesStore.selectedRole){l.value=gameRolesStore.selectedRole.id;const t=localStorage.getItem(`dailyTasks_${l.value}`);if(t)try{r.value=JSON.parse(t)}catch(e){console.error("解析任务数据失败:",e),k()}else k()}else gameRolesStore.gameRoles.length>0&&(l.value=gameRolesStore.gameRoles[0].id,U(l.value))}),Y(()=>gameRolesStore.selectedRole,t=>{t&&t.id!==l.value&&(l.value=t.id)}),(t,e)=>{const o=p("n-icon"),m=p("n-button"),b=p("n-dropdown"),$=p("n-select"),E=p("n-radio-button"),q=p("n-radio-group"),oe=p("n-input"),ne=p("n-empty"),le=p("n-spin");return v(),g("div",Ye,[s("div",Ze,[s("div",et,[s("div",tt,[e[5]||(e[5]=s("div",{class:"header-left"},[s("h1",{class:"page-title"}," 日常任务 "),s("p",{class:"page-subtitle"}," 管理和执行您的日常游戏任务 ")],-1)),s("div",st,[n(m,{type:"primary",size:"large",loading:w.value,onClick:k},{icon:i(()=>[n(o,null,{default:i(()=>[n(C(ge))]),_:1})]),default:i(()=>[e[3]||(e[3]=_(" 刷新任务 ",-1))]),_:1,__:[3]},8,["loading"]),n(b,{options:z,onSelect:ee},{default:i(()=>[n(m,{size:"large"},{icon:i(()=>[n(o,null,{default:i(()=>[n(C(ve))]),_:1})]),default:i(()=>[e[4]||(e[4]=_(" 批量操作 ",-1))]),_:1,__:[4]})]),_:1})])])])]),s("div",at,[s("div",ot,[s("div",nt,[e[9]||(e[9]=s("span",{class:"selector-label"},"选择角色：",-1)),n($,{value:l.value,"onUpdate:value":[e[0]||(e[0]=T=>l.value=T),U],options:j.value,placeholder:"请选择游戏角色",style:{"min-width":"200px"}},null,8,["value","options"]),A.value?(v(),g("div",lt,[s("div",it,[e[6]||(e[6]=s("span",{class:"stat-label"},"总任务：",-1)),s("span",ct,f(I.value.total),1)]),s("div",rt,[e[7]||(e[7]=s("span",{class:"stat-label"},"已完成：",-1)),s("span",dt,f(I.value.completed),1)]),s("div",ut,[e[8]||(e[8]=s("span",{class:"stat-label"},"进度：",-1)),s("span",mt,f(I.value.percentage)+"%",1)])])):h("",!0)])])]),s("div",vt,[s("div",gt,[s("div",kt,[n(q,{value:O.value,"onUpdate:value":[e[1]||(e[1]=T=>O.value=T),P]},{default:i(()=>[n(E,{value:"all"},{default:i(()=>e[10]||(e[10]=[_(" 全部任务 ",-1)])),_:1,__:[10]}),n(E,{value:"pending"},{default:i(()=>e[11]||(e[11]=[_(" 待完成 ",-1)])),_:1,__:[11]}),n(E,{value:"completed"},{default:i(()=>e[12]||(e[12]=[_(" 已完成 ",-1)])),_:1,__:[12]}),n(E,{value:"auto"},{default:i(()=>e[13]||(e[13]=[_(" 自动执行 ",-1)])),_:1,__:[13]})]),_:1},8,["value"]),s("div",ft,[n(oe,{value:D.value,"onUpdate:value":[e[2]||(e[2]=T=>D.value=T),M],placeholder:"搜索任务...",clearable:""},{prefix:i(()=>[n(o,null,{default:i(()=>[n(C(ke))]),_:1})]),_:1},8,["value"])])])])]),s("div",pt,[s("div",_t,[L.value.length?(v(),g("div",ht,[(v(!0),g(G,null,K(L.value,T=>(v(),H(Xe,{key:T.id,task:T,onExecute:F,onToggleStatus:J,"onUpdate:task":d},null,8,["task"]))),128))])):S.value?h("",!0):(v(),g("div",yt,[n(ne,{description:"暂无任务数据",size:"large"},{icon:i(()=>[n(o,null,{default:i(()=>[n(C(fe))]),_:1})]),extra:i(()=>[n(m,{type:"primary",onClick:k},{default:i(()=>e[14]||(e[14]=[_(" 刷新任务 ",-1)])),_:1,__:[14]})]),_:1})])),S.value?(v(),g("div",wt,[n(le,{size:"large"},{description:i(()=>e[15]||(e[15]=[_(" 正在加载任务数据... ",-1)])),_:1})])):h("",!0)])])])}}},Et=Z(xt,[["__scopeId","data-v-f4283972"]]);export{Et as default};
